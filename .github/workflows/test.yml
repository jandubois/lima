name: test

on:
  push:
    branches:
    - master
    - 'release/**'
    paths-ignore:
    - "docs/**"
    - "website/**"
    - "**.md"
  pull_request:
    paths-ignore:
    - "docs/**"
    - "website/**"
    - "**.md"
env:
  LIMACTL_CREATE_ARGS: ""

jobs:
  upgrade:
    name: "Upgrade test"
    runs-on: macos-13
    timeout-minutes: 120
    strategy:
      matrix:
        oldver: ["v0.23.1"]
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
    - uses: actions/setup-go@v5
      with:
        go-version: 1.23.x
    # - name: Cache image used by ${{ matrix.oldver }}/examples/ubuntu-lts.yaml
    #   uses: ./.github/actions/setup_cache_for_template
    #   with:
    #    template: https://raw.githubusercontent.com/lima-vm/lima/${{ matrix.oldver }}/examples/ubuntu-lts.yaml
    - name: Install test dependencies
      run: |
        set -eux -o pipefail
        brew install bash coreutils
        # brew tap-new lima/qemu
        # brew extract --version=8.2.1 qemu lima/qemu
        # brew install lima/qemu/qemu@8.2.1
        curl -L -o qemu-8.2.1.monterey.bottle.tar.gz https://ghcr.io/v2/homebrew/core/qemu/blobs/sha256:41c77f6bac3e8c1664c665fbe2b19b19ee9da57f8e1ad6697348286710cc3575
        brew install ./qemu-8.2.1.monterey.bottle.tar.gz
    - name: Uninstall lima
      run: |
        set -eux -o pipefail
        brew uninstall --ignore-dependencies --force lima
        rm -rf ~/.lima
        rm -rf ~/Library/Caches/lima
    # - name: Test
    #   run: ./hack/test-upgrade.sh ${{ matrix.oldver }} ${{ github.sha }}
    - name: Manual install
      run: |
        set -eux -o pipefail
        curl -fsSL "https://github.com/lima-vm/lima/releases/download/v0.23.1/lima-0.23.1-Darwin-x86_64.tar.gz" | tar Cxzvm /usr/local
        # make all install
        env
        qemu-system-x86_64 --version
        limactl --version
        limactl start --tty=false --log-level=debug
        limactl shell default cat /etc/os-release
    - if: always()
      uses: ./.github/actions/upload_failure_logs_if_exists
